#!/bin/bash

# ==============================================================================
# ASH (Awesome-Skills-Hub) CLI
# ==============================================================================
# A lightweight package manager for AI IDE skills.
# Author: Antigravity Agent
# ==============================================================================

# 颜色定义
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
NC='\033[0m'

# 基础路径配置
# 获取脚本所在目录的上一级目录作为项目根目录
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
SKILLS_DIR="$PROJECT_ROOT/skills"

# 目标路径配置 (用户配置目录)
HOME_DIR="$HOME"
AGENT_SKILLS_DIR="$HOME_DIR/.agent/skills"
CLAUDE_SKILLS_DIR="$HOME_DIR/.claude/skills"

# ------------------------------------------------------------------------------
# 帮助函数
# ------------------------------------------------------------------------------
log_info() { echo -e "${BLUE}[INFO]${NC} $1"; }
log_success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
log_error() { echo -e "${RED}[ERROR]${NC} $1"; }

show_help() {
    echo -e "Usage: ash <command> [args]"
    echo ""
    echo "Commands:"
    echo "  init              Initialize directories and detect IDEs"
    echo "  list              List all available skills"
    echo "  install <name>    Install a skill (creates symlink)"
    echo "     -g, --global   Install globally (Antigravity/Claude) [Default]"
    echo "     -p, --project  Install to current project (.cursor/rules)"
    echo "  sync              Update skills repository (git pull)"
    echo ""
}

# ------------------------------------------------------------------------------
# Command: init
# ------------------------------------------------------------------------------
cmd_init() {
    log_info "Initializing ASH environment..."
    
    # 检测 Antigravity
    if [ -d "$HOME_DIR/.agent" ]; then
        log_success "Detected Antigravity Agent (~/.agent)"
        mkdir -p "$AGENT_SKILLS_DIR"
    fi
    
    # 检测 Claude
    if [ -d "$HOME_DIR/.claude" ]; then
        log_success "Detected Claude CLI (~/.claude)"
        mkdir -p "$CLAUDE_SKILLS_DIR"
    fi
    
    # 创建方便调用的软链 (可选，暂不污染 /usr/local/bin)
    # 此处仅做目录检查
    
    log_success "Initialization complete."
}

# ------------------------------------------------------------------------------
# Command: list
# ------------------------------------------------------------------------------
cmd_list() {
    log_info "Available Skills:"
    # 使用 find 查找所有 .md 文件，排除 README
    find "$SKILLS_DIR" -type f -name "*.md" ! -name "README.md" | while read -r file; do
        # 获取相对路径作为技能名称 (例如 java/expert.md)
        rel_path="${file#$SKILLS_DIR/}"
        # 获取文件内的第一行描述 (尝试解析 YAML 或 Markdown Title)
        # 简单起见，暂只显示文件名
        echo "  - $rel_path"
    done
}

# ------------------------------------------------------------------------------
# Command: install
# ------------------------------------------------------------------------------
cmd_install() {
    local skill_name="$1"
    local mode="global"
    
    # 参数解析 (简单处理)
    if [[ "$2" == "-p" || "$2" == "--project" ]]; then
        mode="project"
    fi
    
    if [ -z "$skill_name" ]; then
        log_error "Please specify a skill name (e.g., java/expert.md)"
        return 1
    fi
    
    local source_file="$SKILLS_DIR/$skill_name"
    if [ ! -f "$source_file" ]; then
        # 尝试自动补全后缀
        if [ -f "${source_file}.md" ]; then
            source_file="${source_file}.md"
        else
            log_error "Skill not found: $skill_name"
            return 1
        fi
    fi
    
    # 确定目标目录
    if [ "$mode" == "global" ]; then
        # 全局安装：链接到 .agent/skills 和 .claude/skills
        local target_name="$(basename "$source_file" .md)" # 提取文件名及其目录结构比较复杂，暂时只用 basename
        # 这里为了避免重名，可以考虑保留目录结构，或者 flat 化
        # 暂时 flat 化，例如 java/expert.md -> expert
        
        # 1. Link to Antigravity
        if [ -d "$AGENT_SKILLS_DIR" ]; then
            # Antigravity 技能通常是一个文件夹包着 SKILL.md，或者直接是 .md
            # 简单起见，我们链接为文件：~/.agent/skills/expert.md
            local target_path="$AGENT_SKILLS_DIR/$(basename "$source_file")"
            ln -sf "$source_file" "$target_path"
            log_success "Linked to Antigravity: $target_path"
        fi
        
        # 2. Link to Claude
        if [ -d "$CLAUDE_SKILLS_DIR" ]; then
            local target_path="$CLAUDE_SKILLS_DIR/$(basename "$source_file")"
            ln -sf "$source_file" "$target_path"
            log_success "Linked to Claude: $target_path"
        fi
        
    elif [ "$mode" == "project" ]; then
        # 项目级安装：链接到 .cursor/rules 或 .windsurfrules
        local cursor_dir=".cursor/rules"
        mkdir -p "$cursor_dir"
        local target_path="$cursor_dir/$(basename "$source_file")"
        if [ -f "$source_file" ]; then
             # Cursor 需要 .mdc 扩展名吗？通常 .md 也可以。
             # 注意：如果是为了 Cursor，可能需要转换内容（去掉 YAML），但软链改不了内容。
             # MVP 阶段直接软链。
             ln -sf "$source_file" "$target_path"
             log_success "Linked to Project (Cursor): $target_path"
        else
             log_error "Source file issue."
        fi
    fi
}

# ------------------------------------------------------------------------------
# Main Dispatch
# ------------------------------------------------------------------------------
case "$1" in
    init)
        cmd_init
        ;;
    list)
        cmd_list
        ;;
    install)
        shift
        cmd_install "$@"
        ;;
    sync)
        log_info "Syncing repository..."
        git -C "$PROJECT_ROOT" pull
        ;;
    *)
        show_help
        ;;
esac
