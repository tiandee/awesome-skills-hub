#!/bin/bash

# ==============================================================================
# ASH (Awesome-Skills-Hub) CLI
# ==============================================================================
# A lightweight package manager for AI IDE skills.
# Author: Tiandee
# Version: 1.0.0
# ==============================================================================

VERSION="1.0.0"

# é¢œè‰²å®šä¹‰
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

# åŸºç¡€è·¯å¾„é…ç½®
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# System Paths
ASH_HOME="$HOME/.ash"
SKILLS_DIR="$ASH_HOME/skills"

# Check if global skills exist. If not, initialize them from the package (First Run Logic)
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
if [ ! -d "$SKILLS_DIR" ]; then
    LOCAL_SKILLS="$PROJECT_ROOT/skills"
    if [ -d "$LOCAL_SKILLS" ]; then
        log_info "é¦–æ¬¡è¿è¡Œï¼Œæ­£åœ¨åˆå§‹åŒ–å…¨å±€ç¯å¢ƒ (~/.ash)..."
        mkdir -p "$ASH_HOME"
        cp -r "$LOCAL_SKILLS" "$SKILLS_DIR"
        log_success "åˆå§‹åŒ–å®Œæˆï¼"
    else
        # Debugging aid
        # log_warn "æœªèƒ½åœ¨å®‰è£…åŒ…å†…æ‰¾åˆ° skills ç›®å½•: $LOCAL_SKILLS"
        :
    fi
fi

# ç›®æ ‡è·¯å¾„é…ç½® (ä»…æ”¯æŒ Skills çš„å¹³å°)
HOME_DIR="$HOME"
AGENT_SKILLS_DIR="$HOME_DIR/.agent/skills"       # Google Antigravity
CURSOR_SKILLS_DIR="$HOME_DIR/.cursor/skills"     # Cursor
TRAE_SKILLS_DIR="$HOME_DIR/.trae/skills"         # TRAE
WINDSURF_SKILLS_DIR="$HOME_DIR/.windsurf/skills" # Windsurf
COPILOT_SKILLS_DIR="$HOME_DIR/.copilot/skills"   # VS Code + Copilot
CLAUDE_SKILLS_DIR="$HOME_DIR/.claude/skills"     # Claude Code
TRAE_CN_SKILLS_DIR="$HOME_DIR/.trae-cn/skills"   # Trae Chinese Version

# ------------------------------------------------------------------------------
# è¾…åŠ©å‡½æ•°: æå–æŠ€èƒ½æè¿° (æ”¯æŒ YAML å’Œ Markdown)
# ------------------------------------------------------------------------------
extract_description() {
    local file="$1"
    if [ ! -f "$file" ]; then return; fi
    
    # æ£€æŸ¥æ˜¯å¦åŒ…å« YAML å‰ç½®å…ƒæ•°æ®
    if [ "$(head -n 1 "$file" 2>/dev/null)" == "---" ]; then
        # ä» YAML ä¸­æå– description æˆ– name
        local desc=$(sed -n '/^description:/p' "$file" | head -n 1 | sed 's/^description:\s*//' | sed 's/^["\x27]//;s/["\x27]$//')
        if [ -n "$desc" ]; then
            echo "$desc"
            return
        fi
        local name=$(sed -n '/^name:/p' "$file" | head -n 1 | sed 's/^name:\s*//' | sed 's/^["\x27]//;s/["\x27]$//')
        if [ -n "$name" ]; then
            echo "$name"
            return
        fi
    fi
    
    # ä¼ ç»Ÿçš„ Markdown æ ‡é¢˜
    head -n 5 "$file" | grep "^# " | head -n 1 | sed 's/^#\s*//'
}

log_info() { echo -e "${BLUE}[ä¿¡æ¯]${NC} $1"; }
log_success() { echo -e "${GREEN}[æˆåŠŸ]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[è­¦å‘Š]${NC} $1"; }
log_error() { echo -e "${RED}[é”™è¯¯]${NC} $1"; }

show_version() {
    echo -e "${CYAN}ASH (Awesome-Skills-Hub) v${VERSION}${NC}"
    echo "AI IDE æŠ€èƒ½ç®¡ç†å·¥å…·"
}

show_help() {
    show_version
    echo ""
    echo -e "${YELLOW}ç”¨æ³•:${NC} ash <å‘½ä»¤> [å‚æ•°]"
    echo ""
    echo -e "${YELLOW}å‘½ä»¤:${NC}"
    echo "  init              åˆå§‹åŒ–ç¯å¢ƒå¹¶æ£€æµ‹å·²å®‰è£…çš„ IDE"
    echo "  list              åˆ—å‡ºæ‰€æœ‰å¯ç”¨æŠ€èƒ½"
    echo "  info <name>       æŸ¥çœ‹æŠ€èƒ½çš„è¯¦ç»†æè¿°å’Œå†…å®¹é¢„è§ˆ"
    echo "  search <keyword>  æ ¹æ®å…³é”®è¯æœç´¢æŠ€èƒ½"
    echo "  status            æ˜¾ç¤ºå·²å®‰è£…çš„æŠ€èƒ½"
    echo "  install <name>    å®‰è£…æŠ€èƒ½ (åˆ›å»ºè½¯é“¾æ¥åˆ°æ‰€æœ‰å·²æ£€æµ‹çš„ IDE)"
    echo "  uninstall <name>  å¸è½½æŠ€èƒ½ (åˆ é™¤è½¯é“¾æ¥ï¼Œæ”¯æŒ --all å¸è½½å…¨éƒ¨)"
    echo "  sync              åŒæ­¥æ›´æ–°æŠ€èƒ½ä»“åº“ (git pull)"
    echo ""
    echo -e "${YELLOW}é€‰é¡¹:${NC}"
    echo "  -v, --version     æ˜¾ç¤ºç‰ˆæœ¬ä¿¡æ¯"
    echo "  -h, --help        æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯"
    echo ""
    echo -e "${YELLOW}ç¤ºä¾‹:${NC}"
    echo "  ash init                      # åˆå§‹åŒ–å¹¶æ£€æµ‹ IDE"
    echo "  ash list                      # æŸ¥çœ‹æ‰€æœ‰æŠ€èƒ½åˆ†ç±»"
    echo "  ash info pdf                  # æŸ¥çœ‹ PDF æŠ€èƒ½è¯¦æƒ…"
    echo "  ash search react              # æœç´¢æŠ€èƒ½"
    echo "  ash install java/expert       # å®‰è£…æŠ€èƒ½"
    echo "  ash status                    # æŸ¥çœ‹å·²å®‰è£…æŠ€èƒ½"
    echo "  ash uninstall expert          # å¸è½½æŒ‡å®šæŠ€èƒ½"
    echo "  ash uninstall --all           # å¸è½½æ‰€æœ‰å·²å®‰è£…æŠ€èƒ½"
}

# ------------------------------------------------------------------------------
# è¾…åŠ©å‡½æ•°: æ™ºèƒ½è§£ææŠ€èƒ½è·¯å¾„
# ------------------------------------------------------------------------------
resolve_skill_path() {
    local input="$1"
    
    # 1. å°è¯•ç›´æ¥åŒ¹é… (å¸¦æˆ–ä¸å¸¦ .md)
    local direct_path="$SKILLS_DIR/$input"
    if [ -f "$direct_path" ]; then
        echo "$direct_path"
        return 0
    fi
    if [ -f "${direct_path}.md" ]; then
        echo "${direct_path}.md"
        return 0
    fi
    
    # 2. åœ¨æ‰€æœ‰åˆ†ç±»ä¸­æœç´¢åŒ¹é…çš„æ–‡ä»¶å
    local filename="$input"
    if [[ "$filename" != *.md ]]; then
        filename="${filename}.md"
    fi
    
    # ä½¿ç”¨ find å¯»æ‰¾æ‰€æœ‰åŒ¹é…é¡¹
    local matches=($(find "$SKILLS_DIR" -type f -name "$filename"))
    local count=${#matches[@]}
    
    if [ "$count" -eq 1 ]; then
        echo "${matches[0]}"
        return 0
    elif [ "$count" -gt 1 ]; then
        echo -e "${YELLOW}[è­¦å‘Š]${NC} å‘ç°å¤šä¸ªåŒ¹é…çš„æŠ€èƒ½ï¼Œè¯·å°è¯•ä½¿ç”¨å®Œæ•´è·¯å¾„å®‰è£…:" >&2
        for match in "${matches[@]}"; do
            local rel="${match#$SKILLS_DIR/}"
            echo -e "  - ${CYAN}ash install $rel${NC}" >&2
        done
        return 2 # å†²çª
    fi
    
    return 1 # æœªæ‰¾åˆ°
}

# ------------------------------------------------------------------------------
# IDE Detection Logic
# ------------------------------------------------------------------------------
detect_ide() {
    local name="$1"
    local check_dir="$2"
    local check_cmd="$3"
    local init_action="$4"

    local found=0
    if [ -n "$check_dir" ] && [ -d "$check_dir" ]; then
        found=1
    elif [ -n "$check_cmd" ] && command -v "$check_cmd" &> /dev/null; then
        found=1
    fi

    if [ $found -eq 1 ]; then
        log_success "æ£€æµ‹åˆ° $name"
        if [ -n "$init_action" ]; then
            eval "$init_action"
        fi
        return 0
    fi
    return 1
}

# ------------------------------------------------------------------------------
# Command: init
# ------------------------------------------------------------------------------
cmd_init() {
    log_info "æ­£åœ¨åˆå§‹åŒ– ASH ç¯å¢ƒ..."
    
    # 1. Google Antigravity
    detect_ide "Google Antigravity" "$HOME_DIR/.agent" "" "mkdir -p \"$AGENT_SKILLS_DIR\""

    # 2. Cursor
    detect_ide "Cursor" "$HOME_DIR/.cursor" "cursor" "mkdir -p \"$CURSOR_SKILLS_DIR\""

    # 3. TRAE
    detect_ide "TRAE" "$HOME_DIR/.trae" "trae" "mkdir -p \"$TRAE_SKILLS_DIR\""

    # 4. Windsurf
    detect_ide "Windsurf" "$HOME_DIR/.windsurf" "windsurf" "mkdir -p \"$WINDSURF_SKILLS_DIR\""

    # 5. VS Code + Copilot
    detect_ide "VS Code + Copilot" "$HOME_DIR/.copilot" "" "mkdir -p \"$COPILOT_SKILLS_DIR\""

    # 6. Claude Code
    detect_ide "Claude Code" "$HOME_DIR/.claude" "claude" "mkdir -p \"$CLAUDE_SKILLS_DIR\""

    # 7. Trae CN (Chinese Version)
    detect_ide "Trae CN" "$HOME_DIR/.trae-cn" "trae" "mkdir -p \"$TRAE_CN_SKILLS_DIR\""

    log_success "åˆå§‹åŒ–å®Œæˆã€‚"
}

# ------------------------------------------------------------------------------
# Command: sync
# ------------------------------------------------------------------------------
cmd_sync() {
    log_info "æ­£åœ¨åŒæ­¥æŠ€èƒ½åº“..."
    
    # 1. å¦‚æœåœ¨é¡¹ç›®ç›®å½•ä¸‹ï¼Œå…ˆæ‹‰å–æœ€æ–°ä»£ç 
    if [ -d "$PROJECT_ROOT/.git" ]; then
        log_info "æ­£åœ¨ä»è¿œç¨‹ä»“åº“æ‹‰å–æ›´æ–° ($PROJECT_ROOT)..."
        (cd "$PROJECT_ROOT" && git pull origin main)
        
        # 2. åŒæ­¥åˆ°å…¨å±€ç›®å½•
        log_info "æ­£åœ¨åŒæ­¥åˆ°å…¨å±€ä¸»ç›®å½• ($SKILLS_DIR)..."
        cp -r "$PROJECT_ROOT/skills/"* "$SKILLS_DIR/"
    else
        log_warn "æœªåœ¨é¡¹ç›®æ ¹ç›®å½•è¿è¡Œï¼Œå°†è·³è¿‡æœ¬åœ°ä»“åº“åŒæ­¥ã€‚"
        log_info "å¦‚æœæ‚¨æƒ³ç›´æ¥ä»è¿œç¨‹åŒæ­¥åˆ°å…¨å±€ï¼Œè¯·å…‹éš†é¡¹ç›®å¹¶è¿è¡Œ install.shã€‚"
    fi
    
    log_success "åŒæ­¥å®Œæˆï¼æ‚¨å¯ä»¥è¿è¡Œ 'ash list' æŸ¥çœ‹æœ€æ–°æŠ€èƒ½ã€‚"
}

# ------------------------------------------------------------------------------
# Command: list
# ------------------------------------------------------------------------------
cmd_list() {
    log_info "å¯ç”¨æŠ€èƒ½åˆ—è¡¨:"
    echo ""
    
    local count=0
    local last_category=""
    
    while IFS= read -r file; do
        # æå–åˆ†ç±»å’Œæ–‡ä»¶å
        local rel_path="${file#$SKILLS_DIR/}"
        local category="${rel_path%/*}"
        local filename="${rel_path##*/}"
        
        # æŒ‰åˆ†ç±»æ˜¾ç¤º
        if [ "$category" != "$last_category" ]; then
            [ "$count" -ne 0 ] && echo ""
            echo -e "${YELLOW}[$category]${NC}"
            last_category="$category"
        fi
        
        echo -e "  ${GREEN}â€¢${NC} ${CYAN}$filename${NC}"
        ((count++))
    done < <(find "$SKILLS_DIR" -type f -name "*.md" ! -name "README.md" | sort)
    
    echo ""
    log_info "å…± $count ä¸ªæŠ€èƒ½å¯ç”¨"
    echo -e "${DIM}æç¤º: ä½¿ç”¨ 'ash info <æŠ€èƒ½å>' æŸ¥çœ‹è¯¦ç»†æè¿°${NC}"
}

# ------------------------------------------------------------------------------
# Command: info
# ------------------------------------------------------------------------------
cmd_info() {
    local skill_name="$1"
    if [ -z "$skill_name" ]; then
        log_error "è¯·æä¾›æŠ€èƒ½åç§° (ä¾‹å¦‚: ash info pdf)"
        return 1
    fi

    local source_file; source_file=$(resolve_skill_path "$skill_name")
    local ret=$?
    
    if [ $ret -eq 0 ]; then
        local rel_path="${source_file#$SKILLS_DIR/}"
        echo -e "${CYAN}æŠ€èƒ½:${NC} $rel_path"
        local desc=$(extract_description "$source_file")
        echo -e "${GREEN}æè¿°:${NC} ${desc:-"(æ— æè¿°)"}"
        
        echo -e "${DIM}å†…å®¹é¢„è§ˆ:${NC}"
        if [ "$(head -n 1 "$source_file" 2>/dev/null)" == "---" ]; then
            sed '1,/---/d' "$source_file" | grep -v "^---" | head -n 10 | sed 's/^/  /'
        else
            head -n 10 "$source_file" | sed 's/^/  /'
        fi
    elif [ $ret -eq 1 ]; then
        log_error "æœªæ‰¾åˆ°åŒ¹é…çš„æŠ€èƒ½: $skill_name"
        return 1
    fi
}

# ------------------------------------------------------------------------------
# Command: search
# ------------------------------------------------------------------------------
cmd_search() {
    local keyword="$1"
    if [ -z "$keyword" ]; then
        log_error "è¯·æä¾›å…³é”®è¯è¿›è¡Œæœç´¢ (ä¾‹å¦‚: ash search react)"
        return 1
    fi

    log_info "æ­£åœ¨æœç´¢å…³é”®è¯: '$keyword' ..."
    echo ""

    local count=0
    while IFS= read -r file; do
        rel_path="${file#$SKILLS_DIR/}"
        # è·å–æè¿°
        first_line=$(extract_description "$file")
        
        # åœ¨è·¯å¾„æˆ–æè¿°ä¸­æœç´¢ (ä¸åŒºåˆ†å¤§å°å†™)
        if echo "$rel_path $first_line" | grep -iq "$keyword"; then
            echo -e "  ${GREEN}â€¢${NC} ${CYAN}$rel_path${NC}"
            if [ -n "$first_line" ]; then
                echo -e "    $first_line"
            fi
            ((count++))
        fi
    done < <(find "$SKILLS_DIR" -type f -name "*.md" ! -name "README.md" | sort)

    if [ $count -eq 0 ]; then
        log_warn "æœªæ‰¾åˆ°åŒ¹é…çš„æŠ€èƒ½: $keyword"
    else
        echo ""
        log_info "æ‰¾åˆ° $count ä¸ªåŒ¹é…é¡¹"
    fi
}

# ------------------------------------------------------------------------------
# Command: status
# ------------------------------------------------------------------------------
cmd_status() {
    log_info "å·²å®‰è£…æŠ€èƒ½çŠ¶æ€:"
    echo ""
    
    local found=0
    
    # Check Antigravity
    if [ -d "$AGENT_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Antigravity (~/.agent/skills):${NC}"
        for link in "$AGENT_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}â€¢${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(æ— )${NC}"
        fi
    fi
    
    found=0
    # Check Cursor
    if [ -d "$CURSOR_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Cursor (~/.cursor/skills):${NC}"
        for link in "$CURSOR_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}â€¢${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(æ— )${NC}"
        fi
    fi

    found=0
    # Check TRAE
    if [ -d "$TRAE_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}TRAE (~/.trae/skills):${NC}"
        for link in "$TRAE_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}â€¢${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(æ— )${NC}"
        fi
    fi

    found=0
    # Check Windsurf
    if [ -d "$WINDSURF_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Windsurf (~/.windsurf/skills):${NC}"
        for link in "$WINDSURF_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}â€¢${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(æ— )${NC}"
        fi
    fi

    found=0
    # Check Copilot
    if [ -d "$COPILOT_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Copilot (~/.copilot/skills):${NC}"
        for link in "$COPILOT_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}â€¢${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(æ— )${NC}"
        fi
    fi

    found=0
    # Check Claude
    if [ -d "$CLAUDE_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Claude (~/.claude/skills):${NC}"
        for link in "$CLAUDE_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}â€¢${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(æ— )${NC}"
        fi
    fi

    found=0
    # Check Trae CN
    if [ -d "$TRAE_CN_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Trae CN (~/.trae-cn/skills):${NC}"
        for link in "$TRAE_CN_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}â€¢${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(æ— )${NC}"
        fi
    fi
    
    echo ""
}

# ------------------------------------------------------------------------------
# Command: install
# ------------------------------------------------------------------------------
# è¾…åŠ©å‡½æ•°: å®‰è£…å•ä¸ªæŠ€èƒ½æ–‡ä»¶åˆ°æ‰€æœ‰æ£€æµ‹åˆ°çš„ IDE
install_skill_file() {
    local source_file="$1"
    local installed=0
    local filename=$(basename "$source_file")

    # Link to Antigravity
    if [ -d "$AGENT_SKILLS_DIR" ]; then
        ln -sf "$source_file" "$AGENT_SKILLS_DIR/$filename"
        ((installed++))
    fi
    
    # Link to Cursor
    if [ -d "$CURSOR_SKILLS_DIR" ]; then
        ln -sf "$source_file" "$CURSOR_SKILLS_DIR/$filename"
        ((installed++))
    fi

    # Link to TRAE
    if [ -d "$TRAE_SKILLS_DIR" ]; then
        ln -sf "$source_file" "$TRAE_SKILLS_DIR/$filename"
        ((installed++))
    fi

    # Link to Windsurf
    if [ -d "$WINDSURF_SKILLS_DIR" ]; then
        ln -sf "$source_file" "$WINDSURF_SKILLS_DIR/$filename"
        ((installed++))
    fi

    # Link to VS Code + Copilot
    if [ -d "$COPILOT_SKILLS_DIR" ]; then
        ln -sf "$source_file" "$COPILOT_SKILLS_DIR/$filename"
        ((installed++))
    fi

    # Link to Claude Code
    if [ -d "$CLAUDE_SKILLS_DIR" ]; then
        ln -sf "$source_file" "$CLAUDE_SKILLS_DIR/$filename"
        ((installed++))
    fi

    # Link to Trae CN
    if [ -d "$TRAE_CN_SKILLS_DIR" ]; then
        ln -sf "$source_file" "$TRAE_CN_SKILLS_DIR/$filename"
        ((installed++))
    fi

    if [ $installed -gt 0 ]; then
        log_success "å·²é“¾æ¥: $filename (${source_file#$SKILLS_DIR/})"
    fi
    return $installed
}

cmd_install() {
    local skill_name="$1"
    
    if [ -z "$skill_name" ]; then
        log_error "è¯·æŒ‡å®šæŠ€èƒ½åç§° (ä¾‹å¦‚: pdf æˆ– --all)"
        return 1
    fi

    if [ "$skill_name" == "--all" ]; then
        # è·å–æ‰€æœ‰å¾…å®‰è£…çš„æŠ€èƒ½æ–‡ä»¶
        local skill_files=()
        while IFS= read -r file; do
            skill_files+=("$file")
        done < <(find "$SKILLS_DIR" -type f -name "*.md" ! -name "README.md" | sort)
        
        local skill_count=${#skill_files[@]}
        log_info "æ­£åœ¨æ‰¹é‡å®‰è£… $skill_count ä¸ªæŠ€èƒ½åˆ°æ‰€æœ‰æ£€æµ‹åˆ°çš„ IDE..."
        echo ""

        # å®šä¹‰ IDE åç§°åŠå…¶å¯¹åº”çš„è·¯å¾„
        local ides=("Antigravity" "Cursor" "TRAE" "Windsurf" "Copilot" "Claude" "Trae CN")
        local dirs=("$AGENT_SKILLS_DIR" "$CURSOR_SKILLS_DIR" "$TRAE_SKILLS_DIR" "$WINDSURF_SKILLS_DIR" "$COPILOT_SKILLS_DIR" "$CLAUDE_SKILLS_DIR" "$TRAE_CN_SKILLS_DIR")
        
        local updated_ides=()
        local total_links=0
        
        # é€ä¸ªå®‰è£…æŠ€èƒ½å¹¶æ˜¾ç¤ºåˆ—è¡¨é£æ ¼çš„è¿›åº¦
        for file in "${skill_files[@]}"; do
            local filename=$(basename "$file")
            local rel_path="${file#$SKILLS_DIR/}"
            echo -e "  ${GREEN}â€¢${NC} ${CYAN}$filename${NC} ${DIM}($rel_path)${NC}"
            
            for i in "${!ides[@]}"; do
                local dir="${dirs[$i]}"
                if [ -d "$dir" ]; then
                    ln -sf "$file" "$dir/$filename"
                    ((total_links++))
                fi
            done
        done

        # ç»Ÿè®¡æœ‰æ•ˆ IDE
        for i in "${!ides[@]}"; do
            [ -d "${dirs[$i]}" ] && updated_ides+=("${ides[$i]}")
        done
        
        echo ""
        if [ ${#updated_ides[@]} -gt 0 ]; then
            local ides_list=$(IFS=,; echo "${updated_ides[*]}")
            log_success "æ‰¹é‡å®‰è£…å®Œæˆï¼"
            echo -e "  ${CYAN}å·²åŒæ­¥ IDE:${NC} ${ides_list//,/ã€}"
            echo -e "  ${CYAN}æ€»é“¾æ¥æ•°:${NC} $total_links"
        else
            log_warn "æœªæ£€æµ‹åˆ°æ”¯æŒçš„ IDE ç¯å¢ƒï¼Œè¯·å…ˆè¿è¡Œ 'ash init'"
        fi
        return 0
    fi
    
    local source_file
    source_file=$(resolve_skill_path "$skill_name")
    local ret=$?
    
    if [ $ret -eq 1 ]; then
        log_error "æŠ€èƒ½æœªæ‰¾åˆ°: $skill_name"
        log_info "ä½¿ç”¨ 'ash list' æŸ¥çœ‹å¯ç”¨æŠ€èƒ½"
        return 1
    elif [ $ret -eq 2 ]; then
        return 1
    fi
    
    install_skill_file "$source_file"
    if [ $? -eq 0 ]; then
        log_warn "æœªæ‰¾åˆ°å¯å®‰è£…çš„ç›®æ ‡ç›®å½•ï¼Œè¯·å…ˆè¿è¡Œ 'ash init'"
    fi
}

# ------------------------------------------------------------------------------
# Helper: Remove all skill links from all IDEs
# ------------------------------------------------------------------------------
remove_all_links() {
    log_info "æ­£åœ¨ä»æ‰€æœ‰ IDE å¸è½½æ‰€æœ‰æŠ€èƒ½..."
    local total_count=0
    
    # å®šä¹‰ IDE åç§°åŠå…¶å¯¹åº”çš„è·¯å¾„
    local ides=("Antigravity" "Cursor" "TRAE" "Windsurf" "Copilot" "Claude" "Trae CN")
    local dirs=("$AGENT_SKILLS_DIR" "$CURSOR_SKILLS_DIR" "$TRAE_SKILLS_DIR" "$WINDSURF_SKILLS_DIR" "$COPILOT_SKILLS_DIR" "$CLAUDE_SKILLS_DIR" "$TRAE_CN_SKILLS_DIR")
    
    for i in "${!ides[@]}"; do
        local ide_name="${ides[$i]}"
        local dir="${dirs[$i]}"
        local ide_count=0
        local removed_skills=()
        
        if [ -d "$dir" ]; then
            # è®°å½•è¯¥ IDE ä¸‹ç§»é™¤çš„æ‰€æœ‰æŠ€èƒ½
            for link in "$dir"/*.md; do
                if [ -L "$link" ]; then
                    local filename=$(basename "$link")
                    rm "$link"
                    removed_skills+=("$filename")
                    ((ide_count++))
                    ((total_count++))
                fi
            done
            
            # è¾“å‡ºè¯¥ IDE çš„ç»“æœ
            if [ $ide_count -gt 0 ]; then
                # å°†æ•°ç»„è½¬æ¢ä¸ºé€—å·åˆ†éš”çš„å­—ç¬¦ä¸²
                local skills_list=$(IFS=,; echo "${removed_skills[*]}")
                echo -e "  ${CYAN}$ide_name:${NC} å·²ç§»é™¤ ${GREEN}$ide_count${NC} ä¸ªæŠ€èƒ½ [${DIM}${skills_list//,/ã€}${NC}]"
            fi
        fi
    done
    
    echo ""
    if [ $total_count -gt 0 ]; then
        log_success "å…¨é‡å¸è½½å®Œæˆï¼Œå…±ä»æ‰€æœ‰ IDE ä¸­ç§»é™¤äº† $total_count ä¸ªé“¾æ¥ã€‚"
    else
        log_warn "æœªå‘ç°ä»»ä½•å·²å®‰è£…çš„æŠ€èƒ½é“¾æ¥ã€‚"
    fi
}

# ------------------------------------------------------------------------------
# Command: uninstall
# ------------------------------------------------------------------------------
cmd_uninstall() {
    local skill_name="$1"
    
    if [ "$skill_name" == "--all" ]; then
        remove_all_links
        return 0
    fi
    
    if [ -z "$skill_name" ]; then
        log_error "è¯·æŒ‡å®šè¦å¸è½½çš„æŠ€èƒ½åç§° (ä¾‹å¦‚: expert æˆ– expert.mdï¼Œæˆ–ä½¿ç”¨ --all)"
        return 1
    fi
    
    # è‡ªåŠ¨è¡¥å…¨ .md åç¼€
    if [[ "$skill_name" != *.md ]]; then
        skill_name="${skill_name}.md"
    fi
    
    local removed=0
    
    # Remove from Antigravity
    local agent_link="$AGENT_SKILLS_DIR/$skill_name"
    if [ -L "$agent_link" ]; then
        rm "$agent_link"
        log_success "å·²ä» Antigravity ç§»é™¤: $skill_name"
        ((removed++))
    fi
    
    # Remove from Cursor
    local cursor_link="$CURSOR_SKILLS_DIR/$skill_name"
    if [ -L "$cursor_link" ]; then
        rm "$cursor_link"
        log_success "å·²ä» Cursor ç§»é™¤: $skill_name"
        ((removed++))
    fi

    # Remove from TRAE
    local trae_link="$TRAE_SKILLS_DIR/$skill_name"
    if [ -L "$trae_link" ]; then
        rm "$trae_link"
        log_success "å·²ä» TRAE ç§»é™¤: $skill_name"
        ((removed++))
    fi

    # Remove from Windsurf
    local windsurf_link="$WINDSURF_SKILLS_DIR/$skill_name"
    if [ -L "$windsurf_link" ]; then
        rm "$windsurf_link"
        log_success "å·²ä» Windsurf ç§»é™¤: $skill_name"
        ((removed++))
    fi

    # Remove from Copilot
    local copilot_link="$COPILOT_SKILLS_DIR/$skill_name"
    if [ -L "$copilot_link" ]; then
        rm "$copilot_link"
        log_success "å·²ä» Copilot ç§»é™¤: $skill_name"
        ((removed++))
    fi

    # Remove from Claude
    local claude_link="$CLAUDE_SKILLS_DIR/$skill_name"
    if [ -L "$claude_link" ]; then
        rm "$claude_link"
        log_success "å·²ä» Claude ç§»é™¤: $skill_name"
        ((removed++))
    fi

    # Remove from Trae CN
    local trae_cn_link="$TRAE_CN_SKILLS_DIR/$skill_name"
    if [ -L "$trae_cn_link" ]; then
        rm "$trae_cn_link"
        log_success "å·²ä» Trae CN ç§»é™¤: $skill_name"
        ((removed++))
    fi
    
    if [ $removed -eq 0 ]; then
        log_warn "æœªæ‰¾åˆ°å·²å®‰è£…çš„æŠ€èƒ½: $skill_name"
    fi
}

# ------------------------------------------------------------------------------
# Main Dispatch
# ------------------------------------------------------------------------------
case "$1" in
    init)
        cmd_init
        ;;
    list)
        cmd_list
        ;;
    info)
        shift
        cmd_info "$@"
        ;;
    search)
        shift
        cmd_search "$@"
        ;;
    status)
        cmd_status
        ;;
    install)
        shift
        cmd_install "$@"
        ;;
    uninstall)
        shift
        cmd_uninstall "$@"
        ;;
    sync)
        log_info "æ­£åœ¨åŒæ­¥æŠ€èƒ½ä»“åº“..."
        git -C "$PROJECT_ROOT" pull
        log_success "åŒæ­¥å®Œæˆã€‚"
        ;;
    -v|--version)
        show_version
        ;;
    -h|--help)
        show_help
        ;;
    "")
        show_help
        ;;
    *)
        command="$1"
        log_error "æœªçŸ¥å‘½ä»¤: '$command'"
        
        # æ™ºèƒ½å»ºè®®é€»è¾‘
        case "$command" in
            intall|insall|instal)
                echo -e "ğŸ’¡ æ‚¨æ˜¯ä¸æ˜¯æƒ³è¾“å…¥: ${CYAN}ash install${NC} ?"
                ;;
            unintall|uninstal)
                echo -e "ğŸ’¡ æ‚¨æ˜¯ä¸æ˜¯æƒ³è¾“å…¥: ${CYAN}ash uninstall${NC} ?"
                ;;
            ls|lst)
                echo -e "ğŸ’¡ æ‚¨æ˜¯ä¸æ˜¯æƒ³è¾“å…¥: ${CYAN}ash list${NC} ?"
                ;;
            serch|find)
                echo -e "ğŸ’¡ æ‚¨æ˜¯ä¸æ˜¯æƒ³è¾“å…¥: ${CYAN}ash search${NC} ?"
                ;;
            stat|st)
                echo -e "ğŸ’¡ æ‚¨æ˜¯ä¸æ˜¯æƒ³è¾“å…¥: ${CYAN}ash status${NC} ?"
                ;;
            *)
                echo -e "è¯¦æƒ…è¯·è¿è¡Œ: ${DIM}ash --help${NC}"
                ;;
        esac
        exit 1
        ;;
esac
