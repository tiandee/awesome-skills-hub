#!/bin/bash

# ==============================================================================
# ASH (Awesome-Skills-Hub) CLI
# ==============================================================================
# A lightweight package manager for AI IDE skills.
# Author: Tiandee
# Version: 1.0.0
# ==============================================================================

VERSION="1.0.0"

# 颜色定义
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
RED='\033[0;31m'
CYAN='\033[0;36m'
NC='\033[0m'

# 基础路径配置
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
SKILLS_DIR="$PROJECT_ROOT/skills"

# 目标路径配置 (仅支持 Skills 的平台)
HOME_DIR="$HOME"
AGENT_SKILLS_DIR="$HOME_DIR/.agent/skills"       # Google Antigravity
CURSOR_SKILLS_DIR="$HOME_DIR/.cursor/skills"     # Cursor
TRAE_SKILLS_DIR="$HOME_DIR/.trae/skills"         # TRAE
WINDSURF_SKILLS_DIR="$HOME_DIR/.windsurf/skills" # Windsurf
COPILOT_SKILLS_DIR="$HOME_DIR/.copilot/skills"   # VS Code + Copilot
CLAUDE_SKILLS_DIR="$HOME_DIR/.claude/skills"     # Claude Code
TRAE_CN_SKILLS_DIR="$HOME_DIR/.trae-cn/skills"   # Trae Chinese Version

# ------------------------------------------------------------------------------
# 辅助函数: 提取技能描述 (支持 YAML 和 Markdown)
# ------------------------------------------------------------------------------
extract_description() {
    local file="$1"
    if [ ! -f "$file" ]; then return; fi
    
    # 检查是否包含 YAML 前置元数据
    if [ "$(head -n 1 "$file" 2>/dev/null)" == "---" ]; then
        # 从 YAML 中提取 description 或 name
        local desc=$(sed -n '/^description:/p' "$file" | head -n 1 | sed 's/^description:\s*//' | sed 's/^["\x27]//;s/["\x27]$//')
        if [ -n "$desc" ]; then
            echo "$desc"
            return
        fi
        local name=$(sed -n '/^name:/p' "$file" | head -n 1 | sed 's/^name:\s*//' | sed 's/^["\x27]//;s/["\x27]$//')
        if [ -n "$name" ]; then
            echo "$name"
            return
        fi
    fi
    
    # 传统的 Markdown 标题
    head -n 5 "$file" | grep "^# " | head -n 1 | sed 's/^#\s*//'
}

log_info() { echo -e "${BLUE}[信息]${NC} $1"; }
log_success() { echo -e "${GREEN}[成功]${NC} $1"; }
log_warn() { echo -e "${YELLOW}[警告]${NC} $1"; }
log_error() { echo -e "${RED}[错误]${NC} $1"; }

show_version() {
    echo -e "${CYAN}ASH (Awesome-Skills-Hub) v${VERSION}${NC}"
    echo "AI IDE 技能管理工具"
}

show_help() {
    show_version
    echo ""
    echo -e "${YELLOW}用法:${NC} ash <命令> [参数]"
    echo ""
    echo -e "${YELLOW}命令:${NC}"
    echo "  init              初始化环境并检测已安装的 IDE"
    echo "  list              列出所有可用技能"
    echo "  search <keyword>  根据关键词搜索技能"
    echo "  status            显示已安装的技能"
    echo "  install <name>    安装技能 (创建软链接到所有已检测的 IDE)"
    echo "  uninstall <name>  卸载技能 (删除软链接，支持 --all 卸载全部)"
    echo "  sync              同步更新技能仓库 (git pull)"
    echo ""
    echo -e "${YELLOW}选项:${NC}"
    echo "  -v, --version     显示版本信息"
    echo "  -h, --help        显示帮助信息"
    echo ""
    echo -e "${YELLOW}示例:${NC}"
    echo "  ash init                      # 初始化并检测 IDE"
    echo "  ash list                      # 查看可用技能"
    echo "  ash search react              # 搜索技能"
    echo "  ash install java/expert       # 安装技能"
    echo "  ash status                    # 查看已安装技能"
    echo "  ash uninstall expert          # 卸载指定技能"
    echo "  ash uninstall --all           # 卸载所有已安装技能"
    echo ""
}

# ------------------------------------------------------------------------------
# IDE Detection Logic
# ------------------------------------------------------------------------------
detect_ide() {
    local name="$1"
    local check_dir="$2"
    local check_cmd="$3"
    local init_action="$4"

    local found=0
    if [ -n "$check_dir" ] && [ -d "$check_dir" ]; then
        found=1
    elif [ -n "$check_cmd" ] && command -v "$check_cmd" &> /dev/null; then
        found=1
    fi

    if [ $found -eq 1 ]; then
        log_success "检测到 $name"
        if [ -n "$init_action" ]; then
            eval "$init_action"
        fi
        return 0
    fi
    return 1
}

# ------------------------------------------------------------------------------
# Command: init
# ------------------------------------------------------------------------------
cmd_init() {
    log_info "正在初始化 ASH 环境..."
    
    # 1. Google Antigravity
    detect_ide "Google Antigravity" "$HOME_DIR/.agent" "" "mkdir -p \"$AGENT_SKILLS_DIR\""

    # 2. Cursor
    detect_ide "Cursor" "$HOME_DIR/.cursor" "cursor" "mkdir -p \"$CURSOR_SKILLS_DIR\""

    # 3. TRAE
    detect_ide "TRAE" "$HOME_DIR/.trae" "trae" "mkdir -p \"$TRAE_SKILLS_DIR\""

    # 4. Windsurf
    detect_ide "Windsurf" "$HOME_DIR/.windsurf" "windsurf" "mkdir -p \"$WINDSURF_SKILLS_DIR\""

    # 5. VS Code + Copilot
    detect_ide "VS Code + Copilot" "$HOME_DIR/.copilot" "" "mkdir -p \"$COPILOT_SKILLS_DIR\""

    # 6. Claude Code
    detect_ide "Claude Code" "$HOME_DIR/.claude" "claude" "mkdir -p \"$CLAUDE_SKILLS_DIR\""

    # 7. Trae CN (Chinese Version)
    detect_ide "Trae CN" "$HOME_DIR/.trae-cn" "trae" "mkdir -p \"$TRAE_CN_SKILLS_DIR\""

    log_success "初始化完成。"
}

# ------------------------------------------------------------------------------
# Command: list
# ------------------------------------------------------------------------------
cmd_list() {
    log_info "可用技能列表:"
    echo ""
    
    local count=0
    while IFS= read -r file; do
        rel_path="${file#$SKILLS_DIR/}"
        first_line=$(extract_description "$file")
        if [ -n "$first_line" ]; then
            echo -e "  ${GREEN}•${NC} ${CYAN}$rel_path${NC}"
            echo -e "    $first_line"
        else
            echo -e "  ${GREEN}•${NC} ${CYAN}$rel_path${NC}"
        fi
        ((count++))
    done < <(find "$SKILLS_DIR" -type f -name "*.md" ! -name "README.md" | sort)
    
    echo ""
    log_info "共 $count 个技能可用"
}

# ------------------------------------------------------------------------------
# Command: search
# ------------------------------------------------------------------------------
cmd_search() {
    local keyword="$1"
    if [ -z "$keyword" ]; then
        log_error "请提供关键词进行搜索 (例如: ash search react)"
        return 1
    fi

    log_info "正在搜索关键词: '$keyword' ..."
    echo ""

    local count=0
    while IFS= read -r file; do
        rel_path="${file#$SKILLS_DIR/}"
        # 获取描述
        first_line=$(extract_description "$file")
        
        # 在路径或描述中搜索 (不区分大小写)
        if echo "$rel_path $first_line" | grep -iq "$keyword"; then
            echo -e "  ${GREEN}•${NC} ${CYAN}$rel_path${NC}"
            if [ -n "$first_line" ]; then
                echo -e "    $first_line"
            fi
            ((count++))
        fi
    done < <(find "$SKILLS_DIR" -type f -name "*.md" ! -name "README.md" | sort)

    if [ $count -eq 0 ]; then
        log_warn "未找到匹配的技能: $keyword"
    else
        echo ""
        log_info "找到 $count 个匹配项"
    fi
}

# ------------------------------------------------------------------------------
# Command: status
# ------------------------------------------------------------------------------
cmd_status() {
    log_info "已安装技能状态:"
    echo ""
    
    local found=0
    
    # Check Antigravity
    if [ -d "$AGENT_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Antigravity (~/.agent/skills):${NC}"
        for link in "$AGENT_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}•${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(无)${NC}"
        fi
    fi
    
    found=0
    # Check Cursor
    if [ -d "$CURSOR_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Cursor (~/.cursor/skills):${NC}"
        for link in "$CURSOR_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}•${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(无)${NC}"
        fi
    fi

    found=0
    # Check TRAE
    if [ -d "$TRAE_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}TRAE (~/.trae/skills):${NC}"
        for link in "$TRAE_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}•${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(无)${NC}"
        fi
    fi

    found=0
    # Check Windsurf
    if [ -d "$WINDSURF_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Windsurf (~/.windsurf/skills):${NC}"
        for link in "$WINDSURF_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}•${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(无)${NC}"
        fi
    fi

    found=0
    # Check Copilot
    if [ -d "$COPILOT_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Copilot (~/.copilot/skills):${NC}"
        for link in "$COPILOT_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}•${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(无)${NC}"
        fi
    fi

    found=0
    # Check Claude
    if [ -d "$CLAUDE_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Claude (~/.claude/skills):${NC}"
        for link in "$CLAUDE_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}•${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(无)${NC}"
        fi
    fi

    found=0
    # Check Trae CN
    if [ -d "$TRAE_CN_SKILLS_DIR" ]; then
        echo -e "  ${CYAN}Trae CN (~/.trae-cn/skills):${NC}"
        for link in "$TRAE_CN_SKILLS_DIR"/*.md; do
            if [ -L "$link" ]; then
                local target=$(readlink "$link")
                local name=$(basename "$link")
                echo -e "    ${GREEN}•${NC} $name -> $target"
                ((found++))
            fi
        done 2>/dev/null
        if [ $found -eq 0 ]; then
            echo -e "    ${YELLOW}(无)${NC}"
        fi
    fi
    
    echo ""
}

# ------------------------------------------------------------------------------
# Command: install
# ------------------------------------------------------------------------------
cmd_install() {
    local skill_name="$1"
    
    if [ -z "$skill_name" ]; then
        log_error "请指定技能名称 (例如: java/expert 或 java/expert.md)"
        return 1
    fi
    
    local source_file="$SKILLS_DIR/$skill_name"
    if [ ! -f "$source_file" ]; then
        if [ -f "${source_file}.md" ]; then
            source_file="${source_file}.md"
        else
            log_error "技能未找到: $skill_name"
            log_info "使用 'ash list' 查看可用技能"
            return 1
        fi
    fi
    
    local installed=0
    
    # Link to Antigravity
    if [ -d "$AGENT_SKILLS_DIR" ]; then
        local target_path="$AGENT_SKILLS_DIR/$(basename "$source_file")"
        ln -sf "$source_file" "$target_path"
        log_success "已链接到 Antigravity: $target_path"
        ((installed++))
    fi
    
    # Link to Cursor
    if [ -d "$CURSOR_SKILLS_DIR" ]; then
        local target_path="$CURSOR_SKILLS_DIR/$(basename "$source_file")"
        ln -sf "$source_file" "$target_path"
        log_success "已链接到 Cursor: $target_path"
        ((installed++))
    fi

    # Link to TRAE
    if [ -d "$TRAE_SKILLS_DIR" ]; then
        local target_path="$TRAE_SKILLS_DIR/$(basename "$source_file")"
        ln -sf "$source_file" "$target_path"
        log_success "已链接到 TRAE: $target_path"
        ((installed++))
    fi

    # Link to Windsurf
    if [ -d "$WINDSURF_SKILLS_DIR" ]; then
        local target_path="$WINDSURF_SKILLS_DIR/$(basename "$source_file")"
        ln -sf "$source_file" "$target_path"
        log_success "已链接到 Windsurf: $target_path"
        ((installed++))
    fi

    # Link to VS Code + Copilot
    if [ -d "$COPILOT_SKILLS_DIR" ]; then
        local target_path="$COPILOT_SKILLS_DIR/$(basename "$source_file")"
        ln -sf "$source_file" "$target_path"
        log_success "已链接到 Copilot: $target_path"
        ((installed++))
    fi

    # Link to Claude Code
    if [ -d "$CLAUDE_SKILLS_DIR" ]; then
        local target_path="$CLAUDE_SKILLS_DIR/$(basename "$source_file")"
        ln -sf "$source_file" "$target_path"
        log_success "已链接到 Claude: $target_path"
        ((installed++))
    fi

    # Link to Trae CN
    if [ -d "$TRAE_CN_SKILLS_DIR" ]; then
        local target_path="$TRAE_CN_SKILLS_DIR/$(basename "$source_file")"
        ln -sf "$source_file" "$target_path"
        log_success "已链接到 Trae CN: $target_path"
        ((installed++))
    fi
    
    if [ $installed -eq 0 ]; then
        log_warn "未找到可安装的目标目录，请先运行 'ash init'"
    fi
}

# ------------------------------------------------------------------------------
# Helper: Remove all skill links from all IDEs
# ------------------------------------------------------------------------------
remove_all_links() {
    log_info "正在从所有 IDE 卸载所有技能..."
    local count=0
    local dirs=("$AGENT_SKILLS_DIR" "$CURSOR_SKILLS_DIR" "$TRAE_SKILLS_DIR" "$WINDSURF_SKILLS_DIR" "$COPILOT_SKILLS_DIR" "$CLAUDE_SKILLS_DIR" "$TRAE_CN_SKILLS_DIR")
    
    for dir in "${dirs[@]}"; do
        if [ -d "$dir" ]; then
            for link in "$dir"/*.md; do
                if [ -L "$link" ]; then
                    rm "$link"
                    ((count++))
                fi
            done
        fi
    done
    
    if [ $count -gt 0 ]; then
        log_success "成功卸载 $count 个技能链接。"
    else
        log_warn "未发现已安装的技能链接。"
    fi
}

# ------------------------------------------------------------------------------
# Command: uninstall
# ------------------------------------------------------------------------------
cmd_uninstall() {
    local skill_name="$1"
    
    if [ "$skill_name" == "--all" ]; then
        remove_all_links
        return 0
    fi
    
    if [ -z "$skill_name" ]; then
        log_error "请指定要卸载的技能名称 (例如: expert 或 expert.md，或使用 --all)"
        return 1
    fi
    
    # 自动补全 .md 后缀
    if [[ "$skill_name" != *.md ]]; then
        skill_name="${skill_name}.md"
    fi
    
    local removed=0
    
    # Remove from Antigravity
    local agent_link="$AGENT_SKILLS_DIR/$skill_name"
    if [ -L "$agent_link" ]; then
        rm "$agent_link"
        log_success "已从 Antigravity 移除: $skill_name"
        ((removed++))
    fi
    
    # Remove from Cursor
    local cursor_link="$CURSOR_SKILLS_DIR/$skill_name"
    if [ -L "$cursor_link" ]; then
        rm "$cursor_link"
        log_success "已从 Cursor 移除: $skill_name"
        ((removed++))
    fi

    # Remove from TRAE
    local trae_link="$TRAE_SKILLS_DIR/$skill_name"
    if [ -L "$trae_link" ]; then
        rm "$trae_link"
        log_success "已从 TRAE 移除: $skill_name"
        ((removed++))
    fi

    # Remove from Windsurf
    local windsurf_link="$WINDSURF_SKILLS_DIR/$skill_name"
    if [ -L "$windsurf_link" ]; then
        rm "$windsurf_link"
        log_success "已从 Windsurf 移除: $skill_name"
        ((removed++))
    fi

    # Remove from Copilot
    local copilot_link="$COPILOT_SKILLS_DIR/$skill_name"
    if [ -L "$copilot_link" ]; then
        rm "$copilot_link"
        log_success "已从 Copilot 移除: $skill_name"
        ((removed++))
    fi

    # Remove from Claude
    local claude_link="$CLAUDE_SKILLS_DIR/$skill_name"
    if [ -L "$claude_link" ]; then
        rm "$claude_link"
        log_success "已从 Claude 移除: $skill_name"
        ((removed++))
    fi

    # Remove from Trae CN
    local trae_cn_link="$TRAE_CN_SKILLS_DIR/$skill_name"
    if [ -L "$trae_cn_link" ]; then
        rm "$trae_cn_link"
        log_success "已从 Trae CN 移除: $skill_name"
        ((removed++))
    fi
    
    if [ $removed -eq 0 ]; then
        log_warn "未找到已安装的技能: $skill_name"
    fi
}

# ------------------------------------------------------------------------------
# Main Dispatch
# ------------------------------------------------------------------------------
case "$1" in
    init)
        cmd_init
        ;;
    list)
        cmd_list
        ;;
    search)
        shift
        cmd_search "$@"
        ;;
    status)
        cmd_status
        ;;
    install)
        shift
        cmd_install "$@"
        ;;
    uninstall)
        shift
        cmd_uninstall "$@"
        ;;
    sync)
        log_info "正在同步技能仓库..."
        git -C "$PROJECT_ROOT" pull
        log_success "同步完成。"
        ;;
    -v|--version)
        show_version
        ;;
    -h|--help)
        show_help
        ;;
    *)
        show_help
        ;;
esac
