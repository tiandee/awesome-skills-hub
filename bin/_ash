#compdef ash

_ash() {
    local context state state_descr line
    typeset -A opt_args

    _arguments -C \
        '1: :->cmds' \
        '2: :->args' \
        && return 0

    case "$state" in
        cmds)
            local commands; commands=(
                "list:List all available skills"
                "info:Show detailed info about a skill"
                "search:Search for skills by keyword"
                "install:Install a skill (support --all)"
                "uninstall:Uninstall a skill (support --all)"
                "status:Show current installation status"
                "sync:Sync skills from remote repository"
                "init:Initialize local environment"
                "help:Show help message"
            )
            _describe -t commands 'ash commands' commands
            ;;
        args)
            case "$line[1]" in
                install|info|uninstall)
                    local -a skills
                    local skills_dir="$HOME/.ash/skills"
                    
                    if [[ -d "$skills_dir" ]]; then
                         # Get all .md files recursively
                         skills=( "$skills_dir"/**/*.md(.N) )
                         # Remove the path prefix to get relative paths (e.g., productivity/pdf.md)
                         skills=( "${(@)skills#$skills_dir/}" )
                    fi

                    if [[ "$line[1]" == "install" || "$line[1]" == "uninstall" ]]; then
                        skills+=( "--all" )
                    fi
                    
                    _describe -t skills 'skills' skills
                    ;;
            esac
            ;;
    esac
}
